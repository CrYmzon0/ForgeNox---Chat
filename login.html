<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Forge-Nox | Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="forge-nox-login.css" />
</head>
<body class="fn-body">
  <div class="fn-bg-gradient"></div>

  <main class="fn-container">
    <section class="fn-card">
      <h1 class="fn-logo">Forge<span>Nox</span></h1>
      <p class="fn-subtitle">Betritt die Schmiede.</p>

      <!-- WICHTIGE ÄNDERUNG HIER -->
      <form class="fn-form" action="/login" method="post" novalidate>
        <label class="fn-label">
          Benutzername
          <input
            type="text"
            name="username"
            class="fn-input"
            placeholder="Dein Name"
            required
          />
        </label>

        <label class="fn-label fn-password-row" style="display: none;">
  Passwort (falls Name registriert)
  <input
    type="password"
    name="password"
    class="fn-input"
    placeholder="Passwort eingeben"
  />
</label>

        <label class="fn-label">
          Geschlecht
          <select name="gender" class="fn-select" required>
            <option value="" disabled selected hidden>Bitte auswählen</option>
            <option value="male">♂️Männlich</option>
            <option value="female">♀️Weiblich</option>
            <option value="diverse">⚧️Divers</option>
            <option value="none">⛔Keine Angabe</option>
          </select>
        </label>

        <label class="fn-checkbox">
          <input type="checkbox" name="rules" required />
          <span>
            Ich habe die
            <a href="#" target="_blank">Regeln von Forge-Nox</a>
            gelesen und akzeptiere sie.
          </span>
        </label>

        <button type="submit" class="fn-btn-primary">
          Forge-Nox betreten
        </button>

        <ul class="fn-error-box"></ul>
      </form>

      <p class="fn-footer-hint">
        Kein Konto? Registrierung folgt später.
      </p>
    </section>
  </main>

<script>
  const form = document.querySelector(".fn-form");
  const username = form.querySelector("input[name='username']");
  const gender = form.querySelector("select[name='gender']");
  const rules = form.querySelector("input[name='rules']");
  const passwordRow = form.querySelector(".fn-password-row");
  const passwordInput = form.querySelector("input[name='password']");

  // --------------------------------------------------
  // Helper: Fehlerbox
  // --------------------------------------------------
  function showErrors(list) {
    const box = document.querySelector(".fn-error-box");
    box.innerHTML = list.map((e) => `<li>${e}</li>`).join("");
    box.style.display = "block";
  }

  function clearErrors() {
    const box = document.querySelector(".fn-error-box");
    box.innerHTML = "";
    box.style.display = "none";
  }

  // --------------------------------------------------
  // Prüfen, ob Username registriert ist → Passwortfeld ein/aus
  // --------------------------------------------------
  async function updatePasswordVisibility() {
    const nameValue = username.value.trim();
    if (!nameValue) {
      passwordRow.style.display = "none";
      passwordRow.classList.remove("is-visible");
      passwordInput.required = false;
      passwordInput.value = "";
      return;
    }

    try {
      const res = await fetch(
        "/check-username?username=" + encodeURIComponent(nameValue)
      );
      const data = await res.json();

      if (data.registered) {
        passwordRow.style.display = "flex";
        passwordRow.classList.add("is-visible");
        passwordInput.required = true;
      } else {
        passwordRow.style.display = "none";
        passwordRow.classList.remove("is-visible");
        passwordInput.required = false;
        passwordInput.value = "";
      }
    } catch (e) {
      // Im Zweifel: kein Passwort erzwingen
      passwordRow.style.display = "none";
      passwordRow.classList.remove("is-visible");
      passwordInput.required = false;
    }
  }

  username.addEventListener("blur", updatePasswordVisibility);
  username.addEventListener("input", () => {
    clearErrors();
  });

  // --------------------------------------------------
  // URL-Parameter (Fehler vom Server)
  // --------------------------------------------------
  (function handleServerError() {
    const params = new URLSearchParams(window.location.search);
    const loginError = params.get("loginError");
    const prefillName = params.get("username");

    if (prefillName) {
      username.value = prefillName;
      updatePasswordVisibility();
    }

    if (loginError === "pw") {
      showErrors(["Falsches Passwort für diesen Benutzernamen."]);
    }
  })();

  // --------------------------------------------------
  // Submit-Validierung
  // --------------------------------------------------
  form.addEventListener("submit", function (e) {
    let errors = [];

    const nameValue = username.value.trim();

    // Benutzername prüfen (wie bisher)
    if (!nameValue) {
      errors.push("Bitte wähle einen Benutzernamen.");
    } else {
      const hasSpecialChars = /[^a-zA-Z0-9]/.test(nameValue);
      const letters = nameValue.replace(/[0-9]/g, "");
      const numbers = nameValue.replace(/[^0-9]/g, "");

      if (letters.length < 3) {
        errors.push("Der Benutzername muss mindestens 3 Buchstaben enthalten.");
      }
      if (hasSpecialChars) {
        errors.push("Der Benutzername darf keine Sonderzeichen enthalten.");
      }
      if (numbers.length > 4) {
        errors.push("Der Benutzername darf maximal 4 Zahlen enthalten.");
      }
    }

    // Geschlecht prüfen
    if (!gender.value) {
      errors.push("Bitte wähle ein Geschlecht.");
    }

    // Regeln prüfen
    if (!rules.checked) {
      errors.push("Bitte bestätige die Regeln von Forge-Nox.");
    }

    // Falls Name registriert & Passwortfeld sichtbar → Passwort prüfen
    if (
      passwordRow.classList.contains("is-visible") &&
      !passwordInput.value.trim()
    ) {
      errors.push("Bitte gib dein Passwort ein.");
    }

    if (errors.length > 0) {
      e.preventDefault();
      showErrors(errors);
      return;
    }

    clearErrors();
    // Formular wird normal abgeschickt → /login
  });
</script>
</body>
</html>